<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }

      .field-row {
        display: flex;
        align-items: center;
        margin-top: 10px;
      }

      .field-row label {
        width: 100px;
        margin-right: 10px;
        font-weight: normal;
      }

      .field-row input {
        flex: 1;
        padding: 8px;
        font-size: 14px;
      }

      select, button {
        width: 100%;
        padding: 8px;
        font-size: 14px;
        margin-top: 5px;
      }

      #manualEditContainer {
        margin-top: 20px;
        border-top: 1px solid #ddd;
        padding-top: 20px;
      }

      #manualEditTitle b {
        font-weight: bold;
      }
  </style>
  </head>
  <body>
    <label for="mealSelect">Select Meal:</label>
    <select id="mealSelect">
      <option selected disabled>-- Select Meal --</option>
    </select>

    <div id="manualEditContainer" style="display:none;">
      <p id="manualEditTitle" style="font-size: 18px; margin-bottom: 15px;"></p>

      <div class="field-row">
        <label for="calories">Calories:</label>
        <input type="text" id="calories" />
      </div>

      <div class="field-row">
        <label for="protein">Protein:</label>
        <input type="text" id="protein" />
      </div>

      <div class="field-row">
        <label for="carb">Carb:</label>
        <input type="text" id="carb" />
      </div>

      <div class="field-row">
        <label for="fat">Fat:</label>
        <input type="text" id="fat" />
      </div>

      <button onclick="saveManualEdit()">Save</button>
      <button onclick="cancelManualEdit()">Cancel</button>
  </div>

  <div id="foodEditContainer" style="display:none; margin-top: 20px;">
    <h3>Edit Meal Ingredients</h3>
    <div id="ingredientsList"></div>
    <button id="saveFoodEditBtn">Save</button>
    <button id="cancelFoodEditBtn">Cancel</button>
  </div>

    <script>
      const meals = JSON.parse('<?= JSON.stringify(meals) ?>');
      const mealsPrep = JSON.parse('<?= JSON.stringify(mealsPrep) ?>');

      window.onload = function () {
        const select = document.getElementById('mealSelect');
    
        Object.keys(meals).forEach(key => {
          const mealName = meals[key].name;
          const opt = document.createElement('option');
          opt.value = mealName;
          opt.textContent = mealName;
          select.appendChild(opt);
        });

        // Automatically update when a meal is selected
			  select.addEventListener('change', function () {
				  const selectedMeal = select.value;
				  if (selectedMeal && selectedMeal !== '-- Select Meal --') {
					  onEditMeal();
				  }
			  });
      };

      function onEditMeal() {
        const meal = document.getElementById('mealSelect').value;
        if (!meal || meal === '-- Select Meal --') {
          alert('Please select a meal first.');
          return;
        }
        // Check if meal exists in MealPrep sheet
        const existsInMealPrep = Object.values(mealsPrep).some(m => m.name === meal);
        if (existsInMealPrep) {
          editMealFromFood(meal);
        } else {
          editMealFromManual(meal);
        }
      }

      function editMealFromFood(mealName) {
        // Hide manual edit container and clear its inputs
        const manualContainer = document.getElementById('manualEditContainer');
        manualContainer.style.display = 'none';
        document.getElementById('calories').value = '';
        document.getElementById('protein').value = '';
        document.getElementById('carb').value = '';
        document.getElementById('fat').value = '';
        manualContainer.dataset.mealName = '';

        const container = document.getElementById('foodEditContainer');
        const listDiv = document.getElementById('ingredientsList');
        listDiv.innerHTML = ''; // Clear previous content

        // Filter ingredients for selected meal
        const ingredients = mealsPrep.filter(m => m.name === mealName);
        if (ingredients.length === 0) {
          alert('No ingredients found for this meal.');
          return;
        }

        // Show container
        container.style.display = 'block';

        // Render each ingredient as a line: Food (text) and Amount (input)
        ingredients.forEach((ingredient, index) => {
          const div = document.createElement('div');
          div.style.marginBottom = '8px';
          div.style.display = 'flex';
          div.style.alignItems = 'center';
          div.style.gap = '10px';

          const foodSpan = document.createElement('span');
          foodSpan.textContent = ingredient.food;
          foodSpan.style.width = '150px';  // fixed width for alignment

          const amountInput = document.createElement('input');
          amountInput.type = 'text';
          amountInput.value = ingredient.amount;
          amountInput.style.flex = '1';   // fill remaining space
          amountInput.dataset.index = index;

          const errorSpan = document.createElement('span');
          errorSpan.style.color = 'red';
          errorSpan.style.minWidth = '140px';
          errorSpan.className = 'error';

          div.appendChild(foodSpan);
          div.appendChild(amountInput);
          div.appendChild(errorSpan);

          listDiv.appendChild(div);
        });

        // Save button handler
        document.getElementById('saveFoodEditBtn').onclick = () => {
          let isValid = true;
          const updatedIngredients = [];

          // Validate all inputs
          listDiv.querySelectorAll('div').forEach(div => {
            const input = div.querySelector('input');
            const error = div.querySelector('.error');
            error.textContent = '';

            const val = input.value.trim();
            if (!val || isNaN(val) || parseFloat(val) <= 0) {
              error.textContent = 'Enter valid positive number';
              isValid = false;
            } else {
              updatedIngredients.push({
                food: div.querySelector('span').textContent,
                amount: parseFloat(val)
              });
            }
          });

          if (!isValid) return;

          // Delete old meal and add updated one
          google.script.run.withSuccessHandler(() => {
            google.script.host.close();
          }).withFailureHandler(err => {
            alert('Error updating meal: ' + err.message);
          }).deleteMeal(mealName);

          // Wait a bit for delete to complete before adding (or chain server calls)
          // Better to chain on server, but here's a quick client-side wait:
          setTimeout(() => {
            google.script.run.withSuccessHandler(() => {
              google.script.host.close();
            }).withFailureHandler(err => {
              alert('Error adding updated meal: ' + err.message);
            }).addMealFromFood({ mealName, ingredients: updatedIngredients });
          }, 500);
        };

        // Cancel button handler
        document.getElementById('cancelFoodEditBtn').onclick = () => {
          container.style.display = 'none';
        };
      }

      // Show manual edit popup
      function editMealFromManual(mealName) {
        // Hide food edit container and clear its contents
        const foodContainer = document.getElementById('foodEditContainer');
        foodContainer.style.display = 'none';
        document.getElementById('ingredientsList').innerHTML = '';

        // Show manual edit container
        const manualContainer = document.getElementById('manualEditContainer');
        manualContainer.style.display = 'block';

        document.getElementById('manualEditTitle').innerHTML = 'Edit Meal Nutrients: <b>' + mealName + '</b>';
        document.getElementById('manualEditContainer').style.display = 'block';

        // Use preloaded data instead of a server call
        const meal = Object.values(meals).find(m => m.name === mealName);
        if (!meal) {
          alert('Meal not found in preloaded data.');
          cancelManualEdit();
          return;
        }

        document.getElementById('calories').value = meal.calories;
        document.getElementById('protein').value = meal.protein;
        document.getElementById('carb').value = meal.carb;
        document.getElementById('fat').value = meal.fat;

        document.getElementById('manualEditContainer').dataset.mealName = mealName;
      }

      // Save manual edit values
      function saveManualEdit() {
        const mealName = document.getElementById('manualEditContainer').dataset.mealName;
        const calories = parseFloat(document.getElementById('calories').value);
        const protein = parseFloat(document.getElementById('protein').value);
        const carb = parseFloat(document.getElementById('carb').value);
        const fat = parseFloat(document.getElementById('fat').value);

        if (
          isNaN(calories) || isNaN(protein) ||
          isNaN(carb) || isNaN(fat)
        ) {
          alert('Please enter valid numeric values for all fields.');
          return;
        }

        const updatedData = { calories, protein, carb, fat };
        google.script.run
          .withSuccessHandler(() => {
            alert('Meal nutrients updated successfully.');
            cancelManualEdit();
          })
          .withFailureHandler(function(err) {
            alert('Error updating meal: ' + err.message);
          })
          .updateMealNutrients(mealName, updatedData);
      }

      function cancelManualEdit() {
        google.script.host.close();
      }
    </script>
  </body>
</html>
